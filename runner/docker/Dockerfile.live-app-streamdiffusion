ARG BASE_IMAGE=livepeer/ai-runner:live-base
FROM ${BASE_IMAGE}

# Install Python 3.11 via pyenv
ARG PYTHON_VERSION=3.11
ENV PIP_PREFER_BINARY=1

RUN pyenv install $PYTHON_VERSION && \
    pyenv global $PYTHON_VERSION && \
    pyenv rehash

# Upgrade pip and install required packages
RUN pip install --no-cache-dir --upgrade pip==23.3.2 setuptools==69.5.1 wheel==0.43.0

# Install StreamDiffusion dependencies (PyTorch with CUDA)
RUN pip install --no-cache-dir --force-reinstall \
    torch==2.7.1+cu128 \
    torchvision==0.22.1+cu128 \
    torchaudio==2.7.1+cu128 \
    --index-url https://download.pytorch.org/whl/cu128

# Install StreamDiffusion lib
ARG STREAMDIFFUSION_VERSION=v1.0.0-rc
RUN pip install --no-cache-dir git+https://github.com/daydreamlive/StreamDiffusion.git@${STREAMDIFFUSION_VERSION}#egg=streamdiffusion[tensorrt,controlnet,ipadapter]

# Install TensorRT bindings and libraries
RUN python -m streamdiffusion.tools.install-tensorrt

# Enable fast HF downloads for StreamDiffusion lib, which uses older huggingface_hub version
RUN pip install --no-cache-dir hf_transfer==0.1.4
ENV HF_HUB_ENABLE_HF_TRANSFER=1

# Disable HF hub connectivity to avoid internet access during runtime.
# This is manually disabled on the script to download models (dl_checkpoints.sh)
ENV HF_HUB_OFFLINE=1

# Create symlink for where StreamDiffusion builds TensorRT engines at runtime
RUN ln -s /models/StreamDiffusion--engines ./engines
# this is required for faceid ipadapter, whose dependency instals on a fixed path
RUN mkdir -p /root && ln -s /models/insightface /root/.insightface
# this one is used only for realesrgan_trt which has ./models hardcoded
RUN ln -s /models/StreamDiffusion--models ./models

# -----------------------------------------------------------------------------
# Install ai-runner-base and streamdiffusion-entrypoint
# -----------------------------------------------------------------------------

# Copy ai-runner-base package and install dependencies first (for caching)
COPY runner/pyproject.toml /app/pyproject.toml
RUN mkdir -p /app/app && touch /app/app/__init__.py
RUN PIP_EXTRA_INDEX_URL=https://download.pytorch.org/whl/cu128 \
    pip install --no-cache-dir --no-build-isolation .

# Copy actual application code
COPY runner/app/ /app/app
COPY runner/images/ /app/images
COPY runner/bench.py /app/bench.py

# Re-install to register package with actual code
RUN PIP_EXTRA_INDEX_URL=https://download.pytorch.org/whl/cu128 \
    pip install --no-cache-dir --no-build-isolation --no-deps .

# Copy and install the entrypoint package
COPY pipelines/streamdiffusion-entrypoint /tmp/streamdiffusion-entrypoint
RUN pip install --no-cache-dir /tmp/streamdiffusion-entrypoint && \
    rm -rf /tmp/streamdiffusion-entrypoint

# Runtime configuration
ARG GIT_SHA
ARG VERSION="undefined"
ARG INFERPY_INITIAL_PARAMS

ENV GIT_SHA="${GIT_SHA}" \
    VERSION="${VERSION}" \
    PIPELINE="live-video-to-video" \
    MODEL_ID="streamdiffusion" \
    INFERPY_INITIAL_PARAMS="${INFERPY_INITIAL_PARAMS}"

CMD ["streamdiffusion-runner"]

